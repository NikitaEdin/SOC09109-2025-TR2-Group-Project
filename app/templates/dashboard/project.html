{% extends "dashboard/dashboard_base.html" %}

{% block main_content %}
    
    <div class="">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        <!--  any messages? -->
            {% if messages %}
                <!-- loop messages -->
                {% for category, message in messages %}
                    <div class="alert alert-{{category}} alert-dismissible fade show" role="alert">
                        {{ message}}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}

            {% endif %}
        {% endwith %}
    </div>

    <div>
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="card-title" >{{project.title}}</h2>
                            <div>
                                <a data-bs-toggle="modal" data-bs-target="#staticBackdrop" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Remove</a>
                                <a href="{{ url_for('edit_project', project_id=project.id) }}" class="btn btn-outline-danger btn-sm mx-1"><i class="fas fa-edit"></i> Edit</a>

                                {% if project.authorID == current_user.id %}
                                    <a href="{{ url_for('manage_access', project_id=project.id) }}" class="btn btn-outline-danger btn-sm mx-1">
                                        <i class="fas fa-user-lock"></i> Manage Access
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                        <h6>Author: {{project.author.username}}</h6>
                        <h6>Flight Code: {{project.flightCode}}</h6>
                        <h6>Created: {{project.created_at.strftime('%B %d, %Y')}} <span class="text-muted">({{ created_at_humanized }})</span></h6>
                        <h6>Edited: {{project.lastEdited.strftime('%B %d, %Y')}} <span class="text-muted">({{ last_edited_humanized }})</span></h6>
                        <h6>Date of Flight: {{project.dateOfFlight.strftime('%B %d, %Y')}} <span class="text-muted">({{ date_status }})</span></h6>
                        <h6>Project Purpose: {{project.get_project_purpose().title}} ({{project.get_project_purpose().code}})</h6>
                        <h6 class="mt-3 text-muted">Description:</h6>
                        <p>{{project.description}}</p>
                    </div>
                    <div class="col-md-6 map">
                        <h5 class="text-muted">Flight Location</h5>
                        <div class="">
                            {% set hidden_form = True %}  
                            {% set latitude = project.latitude %}
                            {% set longitude = project.longitude %}
                            {% set zoom = 14 %}
                            {% set default_marker_latitude = project.latitude %}
                            {% set default_marker_longitude = project.longitude %}
                            {% set map_read_only = 1%}
                            {% set reset_to_default_marker = 1 %}
                            {% set default_marker_msg = 'Flight Location' %}
                            
                            {% include '/create_project/map_location.html'%}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
<!-- Controls -->
<div class="mt-4 container">
    <div class="row">
        <!-- Left Column: Project Timeline -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Project Timeline</h5>
                    <div class="accordion accordion-flush" id="accordionFlushExample">
                        <!-- 28 days -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="flush-headingOne">
                                <button class="accordion-button collapsed napier-accordion-header justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                                    <div class="napier-accordion-text">
                                        <span>28 days in advance</span>
                                        <span>Due in <strong><span id="countdown-30"></span></strong></span>
                                    </div>
                                </button>
                            </h2>
                            <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                                <div class="accordion-body">
                                    <ul class="napier-bullet-list">
                                        <!-- Check if there's no tasks required in 28 days sections -->
                                        {% set has_tasks = false %}

                                        {% if toggles.notamRequired %}
                                            <li>Apply for non-standard flight permission.</li>
                                            {% set has_tasks = true %}
                                        {% endif %}
                                
                                        {% if toggles.leafletDropRequired %}
                                            <li>Prepare leaflets for leaflet drop.</li>
                                            {% set has_tasks = true %}
                                        {% endif %}
                                
                                        {% if not has_tasks %}
                                            <li>Nothing required at this date, start preparing other documentations.</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 7 days -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="flush-headingTwo">
                                <button class="accordion-button collapsed napier-accordion-header" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                                    <div class="napier-accordion-text">
                                        <span>7 days in advance</span>
                                        <span>Due in <strong><span id="countdown-7"></span></strong></span>
                                    </div>
                                </button>
                            </h2>
                            <div id="flush-collapseTwo" class="accordion-collapse collapse" aria-labelledby="flush-headingTwo" data-bs-parent="#accordionFlushExample">
                                <div class="accordion-body">
                                    <ul class="napier-bullet-list">
                                        <li>Complete viability study.</li>
                                        <li>Complete site evaluation.</li>
                                        <li>Complete risk analysis.</li>
                                        {% if toggles.notamRequired %}
                                            <li>Submit NOTAM if appropriate.</li>
                                        {% endif %}
                                        {% if toggles.leafletDropRequired %}
                                            <li>Carry out a leaflet drop and/or a door-to-door advisory campaign.</li>
                                        {% endif %}
                                        {% if project.projectType == 'Urban' %}
                                            <li>Inform police of planned flight.</li>
                                        {% endif %}
                                        {% if toggles.localClubNearby %}
                                            <li>Contact local air club.</li>
                                        {% endif %}
                                        {% if toggles.permissionRequired %}
                                            <li>Obtain permission from relevant landowners of landing and take-off zones.</li>
                                        {% endif %}
                                        <li>Monitor weather of site.</li>
                                        {% if toggles.loadingListRequired %}
                                            <li>Create loading list.</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 24 hours -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="flush-headingThree">
                                <button class="accordion-button collapsed napier-accordion-header" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseThree" aria-expanded="false" aria-controls="flush-collapseThree">
                                    <div class="napier-accordion-text">
                                        <span>24 hours in advance</span>
                                        <span>Due in <strong><span id="countdown-1"></span></strong></span>
                                    </div>
                                </button>
                            </h2>
                            <div id="flush-collapseThree" class="accordion-collapse collapse" aria-labelledby="flush-headingThree" data-bs-parent="#accordionFlushExample">
                                <div class="accordion-body">
                                    <ul class="napier-bullet-list">
                                        <li>Check that relevant contact numbers are recorded on the site evaluation form.</li>
                                        {% if toggles.protectedAreaFlight %}
                                            <li>Contact ATC if the flight operation is to take place within the flight restriction zone or runway protection zone of a protected aerodrome.</li>
                                        {% endif %}
                                        <li>Make go/no-go decision for the flight based on available weather information.</li>
                                        {% if toggles.loadingListRequired %}
                                                <li>Review loading list.</li>
                                        {% endif %}
                                        <li>Prepare and send crew call sheets.</li>
                                        <li>Configure UAS if required (e.g. add expansion bays, prepare custom payloads, etc.)</li>
                                        <li>Check UAS firmware is up to date.</li>
                                        <li>Conduct a test flight is necessary.</li>
                                        <li>Check that the operator ID is clearly displayed on the RPA.</li>
                                        <li>Charge flight batteries, controller(s) and mobile device(s).</li>
                                        <li>Customise flight checklist.</li>
                                        <li>Print flight and UAS documentation as required:
                                            <ul class="napier-bullet-sublist">
                                                <li>Permissions and contacts</li>
                                                <li>Emergency procedures</li>
                                                {% if toggles.loadingListRequired %}
                                                    <li>Customised loading list</li>
                                                {% endif %}
                                                <li>Customised site checklist</li>
                                                <li>UAS assembly instructions</li>
                                                <li>Crew briefing notes</li>
                                                <li>Pre-flight checklist</li>
                                                <li>Post-flight actions checklist</li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- Day of Flight -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="flush-headingFour">
                                <button class="accordion-button collapsed napier-accordion-header" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseFour" aria-expanded="false" aria-controls="flush-collapseFour">
                                    <div class="napier-accordion-text">
                                        <span>Day of flight</span>
                                        <span>Due in <strong><span id="countdown-flight"></span></strong></span>
                                    </div>
                                </button>
                            </h2>
                            <div id="flush-collapseFour" class="accordion-collapse collapse" aria-labelledby="flush-headingFour" data-bs-parent="#accordionFlushExample">
                                <div class="accordion-body">
                                    <ul class="napier-bullet-list">
                                        <li>Ensure relevant account is logged in (e.g. DJI operator).</li>
                                        <li>Pack equipment{% if toggles.loadingListRequired %} using the loading list{% endif %}.</li>
                                        <li>Check for NOTAMs.</li>
                                        <li>Complete site checklist (including a physical tour of the area).</li>
                                        <li>Make go/no-go decision for the flight based on windspeed, weather, presence of uninvolved persons and any unexpected factors.</li>
                                        <li>Assemble the UAS using model-specific checklist.</li> 
                                        <li>Complete crew briefing.</li>
                                        <li>Complete pre-flight checks.</li>
                                        <li>Complete post-flight actions.</li>
                                        <li>Disassemble the UAS using model-specific checklist and pack equipment.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Checklist and Exports -->
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">Documents and Checklist</h5>

                    <!-- Required Documents -->
                    <div class="mb-3">
                        {% if project.projectType == 'Rural' %}
                        <a href="{{ url_for('rural_checklist', project_id=project.id) }}" class="btn btn-primary w-100">
                            <i class="fas fa-file-alt"></i> Required Documents
                        </a>
                        {% elif project.projectType == 'Urban' %}
                        <a href="{{ url_for('urban_checklist', project_id=project.id) }}" class="btn btn-primary w-100">
                            <i class="fas fa-file-alt"></i> Required Documents
                        </a>
                        {% else %}
                        <a href="#" class="btn disabled w-100">
                            <i class="fas fa-file-alt"></i> Required Documents Error
                        </a>
                        {% endif %}
                    </div>

                    <!-- Optional Documents -->
                    <div class="mb-3">
                        <a href="{{ url_for('optional', project_id=project.id) }}" class="btn btn-primary w-100">
                            <i class="fas fa-file"></i> Optional Documents
                        </a>
                    </div>

                    <!-- Personal Checklist -->
                    <div class="mb-3">
                        <a href="{{ url_for('personal', project_id=project.id) }}" class="btn btn-secondary w-100">
                            <i class="fas fa-check-circle"></i> Personal Checklist
                        </a>
                    </div>

                    <!-- Project Files -->
                    <div class="mb-3">
                        <a href="{{ url_for('project_files', project_id=project.id) }}" class="btn btn-primary w-100">
                            <i class="fas fa-folder-open"></i> Project Files
                        </a>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Export Options</h5>

                    <div class="mb-3">
                        <a href="{{ url_for('export_viability_study', project_id=project.id, auto_open=1) }}" class="btn btn-primary w-100 mb-2">
                            <i class="fa-solid fa-download"></i> Export Viability Study (PDF)
                        </a>
                        <a href="{{ url_for('export_site_evaluation', project_id=project.id, auto_open=1) }}" class="btn btn-primary w-100">
                            <i class="fa-solid fa-download"></i> Export Site Evaluation (PDF)
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



    <!-- Prevents ease-in on load, due to map loading in -->
    <style>
        *{
            transition: none !important;
        }
    </style>


<!-- Modal for confirming project removal -->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header bg-danger text-white py-2">
        <p class="modal-title" id="staticBackdropLabel">
          <i class="fas fa-exclamation-triangle me-2"></i> Warning: Project Removal
        </p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body text-center">
        <p class="fs-5">
          Are you sure you want to remove this project? <br> 
          <strong>This action is irreversible!</strong>
        </p>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer d-flex justify-content-center">
        <a href="{{ url_for('remove_project', project_id=project.id) }}" class="btn btn-danger">
          <i class="fas fa-trash-alt me-2"></i> Confirm Delete
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i> Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Script to count down days until 30 days, 7days, 24 hours and day of flight -->
<script>
    var flightDateStr = "{{ project.dateOfFlight.strftime('%Y-%m-%d') }}";
    var flightDate = new Date(flightDateStr);
  
    var countdownTargets = {
      "countdown-flight": flightDate,
      "countdown-30": new Date(flightDate.getTime() - 30 * 24 * 60 * 60 * 1000),
      "countdown-7": new Date(flightDate.getTime() - 7 * 24 * 60 * 60 * 1000),
      "countdown-1": new Date(flightDate.getTime() - 1 * 24 * 60 * 60 * 1000)
    };
  
    setInterval(function () {
      var now = new Date().getTime();
  
      for (var id in countdownTargets) {
        var target = countdownTargets[id].getTime();
        var distance = target - now;
  
        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  
        var el = document.getElementById(id);
        if (!el) continue;
  
        if (distance < 0) {
          el.innerHTML = "Past Due";
        } else if (days === 0 && hours === 0) {
          el.innerHTML = "Now";
        } else if (days === 0) {
          el.innerHTML = hours + "hours";
        } else {
          el.innerHTML = days + "days " + hours + "hours";
        }
      }
    }, 1000);
</script>
  
  
  

{% endblock %}

    
